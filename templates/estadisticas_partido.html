{% extends 'base.html' %}
{% block content %}
<style>
    /* Estilo para el área del marcador */
    .score-area {
        background: #f0f0f0;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .score-display {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
    }

    .team-score {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 120px;
        height: 120px;
        border-radius: 10px;
        padding: 10px;
        color: white;
    }

    .local-team {
        background-color: #1e90ff;
    }

    .visitor-team {
        background-color: #ff4500;
    }

    .team-score h4 {
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: white;
        text-transform: uppercase;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
    }

    .team-score span {
        font-size: 2.5rem;
        font-weight: bold;
        color: white;
    }

    .set-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #d3d3d3;
        border-radius: 5px;
        padding: 5px 10px;
    }

    .set-info h5 {
        font-size: 0.9rem;
        color: #333;
        margin-bottom: 5px;
    }

    .set-info span {
        font-size: 1.3rem;
        font-weight: bold;
        color: #333;
    }

    .score-controls {
        display: flex;
        flex-direction: row; /* Botones del marcador uno al lado del otro */
        justify-content: center;
        align-items: center;
        gap: 15px; /* Separación horizontal entre botones */
        margin-top: 10px;
    }

    .previous-sets {
        margin-top: 15px;
        display: flex;
        justify-content: center;
        gap: 20px;
        font-size: 0.9rem;
        color: #333;
    }

    .previous-set {
        background-color: #e0e0e0;
        border-radius: 5px;
        padding: 5px 10px;
    }

    /* Estilo para los selectores de jugadores */
    .player-selector-container {
        display: flex;
        flex-wrap: nowrap; /* Siempre en una línea */
        overflow-x: auto; /* Scroll horizontal en móviles */
        gap: 10px;
        justify-content: flex-start;
        padding-bottom: 10px; /* Espacio para el scroll */
    }

    .player-selector-card {
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1), -5px -5px 15px rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        padding: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
        flex: 0 0 120px; /* Tamaño fijo para mantener en una línea */
        min-width: 120px; /* Mínimo ancho para legibilidad */
        box-sizing: border-box;
    }

    .player-selector-card:hover {
        box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.15), -5px -5px 20px rgba(255, 255, 255, 0.9);
    }

    .player-selector-card.selected {
        background: linear-gradient(145deg, #eebf06, rgba(234, 203, 55, 0.71));
    }

    .player-selector-card label {
        color: #333;
        margin-bottom: 3px;
        display: block;
        font-size: 0.8rem;
        text-align: center;
    }

    .player-selector-card select {
        font-size: 0.8rem;
        padding: 4px;
        height: 28px;
        width: 100%;
    }

    .player-selector-card button {
        font-size: 0.7rem;
        padding: 4px 8px;
        margin-top: 5px;
        width: 100%;
    }

    /* Estilo para las pestañas de estadísticas */
    .nav-tabs {
        border-bottom: 1px solid #e0e0e0;
        margin-top: 15px;
    }

    .nav-tabs .nav-link {
        color: #666;
        border: none;
        border-radius: 8px 8px 0 0;
        transition: background-color 0.3s, color 0.3s;
        font-size: 0.75rem;
    }

    .nav-tabs .nav-link:hover {
        background-color: #f0f0f0;
        color: #333;
    }

    .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
    }

    .tab-content {
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1), -5px -5px 15px rgba(255, 255, 255, 0.8);
        border-radius: 0 8px 8px 8px;
        padding: 15px;
        position: relative;
    }

    .tab-content .player-info {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        min-width: 100px;
    }

    .tab-content .player-info .player-name {
        font-size: 0.75rem;
        color: #333;
        margin-bottom: 5px;
    }

    .tab-content .player-info .player-number {
        font-size: 3rem;
        font-weight: bold;
        color: #007bff;
        line-height: 1;
    }

    .tab-pane .d-flex {
        gap: 20px;
    }

    /* Estilo para los botones dentro de las pestañas */
    .stat-controls {
        display: flex;
        flex-direction: column; /* Botones uno encima del otro */
        gap: 8px; /* Separación vertical */
        align-items: center;
    }

    /* Estilo moderno para los botones de + y - */
    .btn-circle {
        width: 35px; /* Botones más grandes */
        height: 35px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1rem; /* Iconos más grandes */
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        line-height: 35px;
    }

    .btn-circle:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .btn-circle:active {
        transform: scale(0.95);
    }

    .btn-circle.success {
        background-color: #28a745;
        color: white;
    }

    .btn-circle.danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-circle:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* Estilo para el área de resumen y notas */
    .summary-notes {
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1), -5px -5px 15px rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        padding: 15px;
    }

    .summary-notes h4 {
        color: #333;
        margin-bottom: 10px;
    }

    .summary-notes p {
        color: #666;
        font-size: 0.85rem;
        line-height: 1.4;
    }

    .summary-notes textarea {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        font-size: 0.8rem;
    }

    /* Estilo para los botones secundarios */
    .action-buttons button {
        padding: 8px 15px;
        font-size: 0.8rem;
        border-radius: 8px;
        transition: background-color 0.3s;
        margin-top: 10px;
    }

    .action-buttons .btn-primary {
        background-color: #007bff;
        border: none;
    }

    .action-buttons .btn-primary:hover {
        background-color: #0056b3;
    }

    .action-buttons .btn-warning {
        background-color: #ffc107;
        border: none;
    }

    .action-buttons .btn-warning:hover {
        background-color: #e0a800;
    }

    .action-buttons .btn-success {
        background-color: #28a745;
        border: none;
    }

    .action-buttons .btn-success:hover {
        background-color: #218838;
    }

    .action-buttons .btn-danger {
        background-color: #dc3545;
        border: none;
    }

    .action-buttons .btn-danger:hover {
        background-color: #c82333;
    }

    .action-buttons .btn-info {
        background-color: #17a2b8;
        border: none;
    }

    .action-buttons .btn-info:hover {
        background-color: #138496;
    }

    /* Ajustes para responsividad */
    @media (max-width: 768px) { /* Tablets y móviles */
        .team-score {
            width: 100px;
            height: 100px;
        }

        .team-score h4 {
            font-size: 0.7rem;
        }

        .team-score span {
            font-size: 2rem;
        }

        .set-info h5 {
            font-size: 0.8rem;
        }

        .set-info span {
            font-size: 1.1rem;
        }

        .score-controls {
            gap: 10px; /* Separación ajustada para móviles */
        }

        .btn-circle {
            width: 30px; /* Tamaño ajustado para móviles */
            height: 30px;
            font-size: 0.9rem;
        }

        .player-selector-card {
            flex: 0 0 100px; /* Menor tamaño en móviles */
            min-width: 100px;
        }

        .player-selector-card label {
            font-size: 0.7rem;
        }

        .player-selector-card select {
            font-size: 0.7rem;
            height: 25px;
        }

        .player-selector-card button {
            font-size: 0.6rem;
            padding: 3px 6px;
        }

        .stat-controls {
            gap: 6px; /* Menor separación en móviles */
        }
    }

    @media (max-width: 576px) { /* Móviles pequeños */
        .score-area {
            padding: 10px;
        }

        .team-score {
            width: 90px;
            height: 90px;
        }

        .team-score h4 {
            font-size: 0.6rem;
        }

        .team-score span {
            font-size: 1.8rem;
        }

        .btn-circle {
            width: 28px;
            height: 28px;
            font-size: 0.8rem;
        }

        .player-selector-container {
            gap: 8px;
        }

        .player-selector-card {
            flex: 0 0 90px;
            min-width: 90px;
        }
    }
</style>

<div class="container mt-3">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center">Estadísticas en Tiempo Real - {{ partido.rival }} vs {{ partido.equipo.nombre }}</h2>
            <div class="score-area">
                <div class="score-display">
                    <div class="team-score local-team">
                        <h4>{{ partido.equipo.nombre }}</h4>
                        <span id="scoreLocal">0</span>
                        <div class="score-controls">
                            <button class="btn-circle success" id="localIncrement" onclick="updateScore('local', 'increment')"><i class="bi bi-plus"></i></button>
                            <button class="btn-circle danger" id="localDecrement" onclick="updateScore('local', 'decrement')"><i class="bi bi-dash"></i></button>
                        </div>
                    </div>
                    <div class="set-info">
                        <h5>SET</h5>
                        <span id="setNumber">{{ currentSet }}</span>
                        <span id="setScore">{{ partido.equipo.nombre }} 0 - 0 {{ partido.rival }}</span>
                    </div>
                    <div class="team-score visitor-team">
                        <h4>{{ partido.rival }}</h4>
                        <span id="scoreVisitante">0</span>
                        <div class="score-controls">
                            <button class="btn-circle success" id="visitorIncrement" onclick="updateScore('visitante', 'increment')"><i class="bi bi-plus"></i></button>
                            <button class="btn-circle danger" id="visitorDecrement" onclick="updateScore('visitante', 'decrement')"><i class="bi bi-dash"></i></button>
                        </div>
                    </div>
                </div>
                <div class="previous-sets" id="previousSets">
                    <!-- Previous set scores will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Selección de jugadores en cancha -->
    <div class="row mb-3">
        <div class="col-12">
            <h4>Jugadores en Cancha</h4>
            <div class="player-selector-container">
                {% for pos in range(1, 8) %}
                <div class="player-selector-card" id="card_{{ pos }}">
                    <label>Puesto {{ pos }}</label>
                    <select class="form-control" id="posicion_{{ pos }}" onchange="updateTitular({{ partido.id }}, this.value, {{ pos }})">
                        <option value="">-- Selecciona --</option>
                        {% for jugador in jugadores %}
                        {% set stat = estadisticas|selectattr("jugador_id", "equalto", jugador.id)|first %}
                        <option value="{{ jugador.id }}" {% if stat and stat.posicion == pos %}selected{% endif %} data-numero="{{ jugador.numero }}">
                            {{ jugador.nombre }} ({{ jugador.posicion }} - {{ jugador.numero }})
                        </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-light mt-1 w-100" id="select_btn_{{ pos }}" onclick="selectPlayerFromPosition({{ pos }})">Seleccionar</button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Panel de acciones -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="statTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="saque-tab" data-bs-toggle="tab" href="#saque" role="tab">Saque</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="ataque-tab" data-bs-toggle="tab" href="#ataque" role="tab">Ataque</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="recepcion-tab" data-bs-toggle="tab" href="#recepcion" role="tab">Recepción</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="bloqueo-tab" data-bs-toggle="tab" href="#bloqueo" role="tab">Bloqueo</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="defensa-tab" data-bs-toggle="tab" href="#defensa" role="tab">Defensa</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="asistencia-tab" data-bs-toggle="tab" href="#asistencia" role="tab">Asistencia</a>
                </li>
            </ul>
            <div class="tab-content mt-3" id="statTabsContent">
                <div class="player-info" id="playerInfo">
                    <div class="player-name" id="selectedPlayerName"></div>
                    <div class="player-number" id="selectedPlayerNumber"></div>
                </div>
                <div class="tab-pane fade show active" id="saque" role="tabpanel">
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span>Ace: <span id="saques_ace">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'saques_ace', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'saques_ace', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Error: <span id="saques_fallidos">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'saques_fallidos', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'saques_fallidos', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Total: <span id="saques_totales">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="ataque" role="tabpanel">
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span>Puntos: <span id="ataques_puntos">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'ataques_puntos', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'ataques_puntos', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Error: <span id="ataques_fallidos">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'ataques_fallidos', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'ataques_fallidos', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Bloqueado: <span id="ataques_bloqueados">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'ataques_bloqueados', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'ataques_bloqueados', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Efectividad: <span id="efectividad_ataque">0%</span></span>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="recepcion" role="tabpanel">
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span>Perfectas: <span id="recepciones_perfectas">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'recepciones_perfectas', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'recepciones_perfectas', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Positivas: <span id="recepciones_positivas">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'recepciones_positivas', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'recepciones_positivas', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Errores: <span id="recepciones_fallidas">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'recepciones_fallidas', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'recepciones_fallidas', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="bloqueo" role="tabpanel">
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span>Puntos: <span id="bloqueos_puntos">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'bloqueos_puntos', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'bloqueos_puntos', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Toques: <span id="bloqueos_toques">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'bloqueos_toques', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'bloqueos_toques', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="defensa" role="tabpanel">
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span>Levantadas: <span id="defensas_levantadas">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'defensas_levantadas', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'defensas_levantadas', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Errores: <span id="defensas_fallidas">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'defensas_fallidas', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'defensas_fallidas', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="asistencia" role="tabpanel">
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <span>Asistencias: <span id="asistencias">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'asistencias', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'asistencias', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                        <div>
                            <span>Errores: <span id="asistencias_fallidas">0</span></span>
                            <div class="stat-controls">
                                <button class="btn-circle success" onclick="updateStat(selectedPlayer, 'asistencias_fallidas', 'increment')"><i class="bi bi-plus"></i></button>
                                <button class="btn-circle danger" onclick="updateStat(selectedPlayer, 'asistencias_fallidas', 'decrement')"><i class="bi bi-dash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen y notas -->
    <div class="row mt-3 summary-notes">
        <div class="col-12 col-md-6">
            <h4>Resumen del Jugador</h4>
            <p id="resumenJugador">Selecciona un jugador para ver su resumen.</p>
        </div>
        <div class="col-12 col-md-6">
            <h4>Notas</h4>
            <textarea id="notas" class="form-control" rows="2" placeholder="Notas rápidas"></textarea>
        </div>
    </div>

    <!-- Botones secundarios -->
    <div class="row mt-3 action-buttons">
        <div class="col-12 text-center">
            <button class="btn btn-primary me-2" onclick="rotatePositions()">Rotar Posiciones</button>
            <button class="btn btn-warning me-2" onclick="undoLastAction()">Deshacer</button>
            <button class="btn btn-danger me-2" onclick="exportarEstadisticas()"><i class="bi bi-file-earmark-pdf"></i> Exportar PDF</button>
            <button class="btn btn-info" onclick="grabarJuego()"><i class="bi bi-save"></i> Grabar Juego</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js"></script>
<script>
localStorage.debug = 'socket.io-client:*';
const socket = io('https://www.voleystats.com.ar', {
    transports: ['websocket', 'polling']
});
let selectedPlayer = null;
let selectedPosition = null;
let lastAction = null;
let currentSet = 1;
let setsWonLocal = 0;
let setsWonVisitante = 0;
let maxSets = 5;
let setScores = [];
let matchEnded = false;

function initializeMatchData() {
    const initialSetScores = {{ partido.set_scores|tojson|safe }} || [];
    setScores = initialSetScores;
    setsWonLocal = setScores.filter(s => s.local > s.visitante).length;
    setsWonVisitante = setScores.filter(s => s.visitante > s.local).length;
    currentSet = setScores.length + 1;

    if ("{{ partido.estado }}" === "Finalizado") {
        matchEnded = true;
        document.getElementById('scoreLocal').innerText = {{ partido.marcador_local|default(0) }};
        document.getElementById('scoreVisitante').innerText = {{ partido.marcador_visitante|default(0) }};
        document.getElementById('localIncrement').disabled = true;
        document.getElementById('localDecrement').disabled = true;
        document.getElementById('visitorIncrement').disabled = true;
        document.getElementById('visitorDecrement').disabled = true;
    } else {
        document.getElementById('scoreLocal').innerText = {{ partido.marcador_local|default(0) }};
        document.getElementById('scoreVisitante').innerText = {{ partido.marcador_visitante|default(0) }};
    }

    document.getElementById('setScore').innerText = `{{ partido.equipo.nombre }} ${setsWonLocal} - ${setsWonVisitante} {{ partido.rival }}`;
    document.getElementById('setNumber').innerText = currentSet;
    displayPreviousSets();
}

function selectPlayerFromPosition(posicion) {
    const select = document.getElementById(`posicion_${posicion}`);
    const jugador_id = select.value;
    if (jugador_id) {
        selectedPlayer = parseInt(jugador_id);
        selectedPosition = posicion;
        document.querySelectorAll('.player-selector-card').forEach(card => card.classList.remove('selected'));
        document.getElementById(`card_${posicion}`).classList.add('selected');
        const selectedOption = select.options[select.selectedIndex];
        const playerName = selectedOption.text.split(' (')[0];
        const playerNumber = selectedOption.getAttribute('data-numero') || 'N/A';
        document.getElementById('selectedPlayerName').innerText = playerName;
        document.getElementById('selectedPlayerNumber').innerText = playerNumber;
        loadPlayerStats(selectedPlayer);
        updateResumen(selectedPlayer);
    } else {
        selectedPlayer = null;
        selectedPosition = null;
        document.querySelectorAll('.player-selector-card').forEach(card => card.classList.remove('selected'));
        document.getElementById('selectedPlayerName').innerText = '';
        document.getElementById('selectedPlayerNumber').innerText = '';
        resetStatsDisplay();
        document.getElementById('resumenJugador').innerText = 'Selecciona un jugador para ver su resumen.';
    }
}

function loadPlayerStats(jugador_id) {
    fetch(`/api/estadisticas?tipo=por_partido&jugador_id=${jugador_id}&partido_id={{ partido.id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error en los datos:', data.error);
                resetStatsDisplay();
            } else {
                document.getElementById('saques_ace').innerText = data.saques_ace || 0;
                document.getElementById('saques_fallidos').innerText = data.saques_fallidos || 0;
                document.getElementById('saques_totales').innerText = data.saques_totales || 0;
                document.getElementById('ataques_puntos').innerText = data.ataques_puntos || 0;
                document.getElementById('ataques_fallidos').innerText = data.ataques_fallidos || 0;
                document.getElementById('ataques_bloqueados').innerText = data.ataques_bloqueados || 0;
                document.getElementById('efectividad_ataque').innerText = (data.efectividad_ataque || 0).toFixed(2) + '%';
                document.getElementById('recepciones_perfectas').innerText = data.recepciones_perfectas || 0;
                document.getElementById('recepciones_positivas').innerText = data.recepciones_positivas || 0;
                document.getElementById('recepciones_fallidas').innerText = data.recepciones_fallidas || 0;
                document.getElementById('bloqueos_puntos').innerText = data.bloqueos_puntos || 0;
                document.getElementById('bloqueos_toques').innerText = data.bloqueos_toques || 0;
                document.getElementById('defensas_levantadas').innerText = data.defensas_levantadas || 0;
                document.getElementById('defensas_fallidas').innerText = data.defensas_fallidas || 0;
                document.getElementById('asistencias').innerText = data.asistencias || 0;
                document.getElementById('asistencias_fallidas').innerText = data.asistencias_fallidas || 0;
                updateResumen(jugador_id);
            }
        })
        .catch(error => {
            console.error('Error al cargar estadísticas:', error);
            resetStatsDisplay();
        });
}

function resetStatsDisplay() {
    document.getElementById('saques_ace').innerText = '0';
    document.getElementById('saques_fallidos').innerText = '0';
    document.getElementById('saques_totales').innerText = '0';
    document.getElementById('ataques_puntos').innerText = '0';
    document.getElementById('ataques_fallidos').innerText = '0';
    document.getElementById('ataques_bloqueados').innerText = '0';
    document.getElementById('efectividad_ataque').innerText = '0%';
    document.getElementById('recepciones_perfectas').innerText = '0';
    document.getElementById('recepciones_positivas').innerText = '0';
    document.getElementById('recepciones_fallidas').innerText = '0';
    document.getElementById('bloqueos_puntos').innerText = '0';
    document.getElementById('bloqueos_toques').innerText = '0';
    document.getElementById('defensas_levantadas').innerText = '0';
    document.getElementById('defensas_fallidas').innerText = '0';
    document.getElementById('asistencias').innerText = '0';
    document.getElementById('asistencias_fallidas').innerText = '0';
}

function updateStat(jugador_id, stat, action) {
    if (!jugador_id) {
        alert('Selecciona un jugador primero.');
        return;
    }
    socket.emit('update_stat', { partido_id: {{ partido.id }}, jugador_id: jugador_id, stat: stat, action: action });
    lastAction = { jugador_id, stat, action };
}

function rotatePositions() {
    socket.emit('rotate_positions', { partido_id: {{ partido.id }} });
}

function undoLastAction() {
    if (!lastAction) return;
    const oppositeAction = lastAction.action === 'increment' ? 'decrement' : 'increment';
    socket.emit('update_stat', { partido_id: {{ partido.id }}, jugador_id: lastAction.jugador_id, stat: lastAction.stat, action: oppositeAction });
    lastAction = null;
}

function updateScore(team, action) {
    if (matchEnded) return;

    let scoreLocal = parseInt(document.getElementById('scoreLocal').innerText);
    let scoreVisitante = parseInt(document.getElementById('scoreVisitante').innerText);
    if (team === 'local') {
        if (action === 'increment') scoreLocal++;
        else if (action === 'decrement' && scoreLocal > 0) scoreLocal--;
    } else {
        if (action === 'increment') scoreVisitante++;
        else if (action === 'decrement' && scoreVisitante > 0) scoreVisitante--;
    }
    document.getElementById('scoreLocal').innerText = scoreLocal;
    document.getElementById('scoreVisitante').innerText = scoreVisitante;

    const targetScore = currentSet === 5 ? 15 : 25;
    let setEnded = false;
    if (scoreLocal >= targetScore && scoreLocal - scoreVisitante >= 2) {
        setsWonLocal++;
        setScores.push({ set: currentSet, local: scoreLocal, visitante: scoreVisitante });
        setEnded = true;
        resetSet();
    } else if (scoreVisitante >= targetScore && scoreVisitante - scoreLocal >= 2) {
        setsWonVisitante++;
        setScores.push({ set: currentSet, local: scoreLocal, visitante: scoreVisitante });
        setEnded = true;
        resetSet();
    }

    document.getElementById('setScore').innerText = `{{ partido.equipo.nombre }} ${setsWonLocal} - ${setsWonVisitante} {{ partido.rival }}`;

    socket.emit('update_score', {
        partido_id: {{ partido.id }},
        scoreLocal: setEnded ? 0 : scoreLocal,
        scoreVisitante: setEnded ? 0 : scoreVisitante,
        set_scores: setScores
    });
}

function resetSet() {
    if (setsWonLocal >= 3 || setsWonVisitante >= 3) {
        matchEnded = true;
        alert(`Partido terminado! ${setsWonLocal > setsWonVisitante ? '{{ partido.equipo.nombre }}' : '{{ partido.rival }}'} gana ${setsWonLocal}:${setsWonVisitante}`);
        document.getElementById('localIncrement').disabled = true;
        document.getElementById('localDecrement').disabled = true;
        document.getElementById('visitorIncrement').disabled = true;
        document.getElementById('visitorDecrement').disabled = true;

        fetch(`/partido/finalizar/{{ partido.id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                marcador_local: 0,
                marcador_visitante: 0,
                set_scores: setScores
            })
        })
        .then(response => response.json())
        .then(data => console.log(data.message))
        .catch(error => {
            console.error('Error al finalizar el partido:', error);
            alert('Error al finalizar el partido');
        });
        return;
    }

    document.getElementById('scoreLocal').innerText = 0;
    document.getElementById('scoreVisitante').innerText = 0;
    currentSet++;
    document.getElementById('setNumber').innerText = currentSet;
    document.getElementById('setScore').innerText = `{{ partido.equipo.nombre }} ${setsWonLocal} - ${setsWonVisitante} {{ partido.rival }}`;
    displayPreviousSets();
}

function displayPreviousSets() {
    const previousSetsDiv = document.getElementById('previousSets');
    previousSetsDiv.innerHTML = '';
    setScores.forEach(score => {
        const setDiv = document.createElement('div');
        setDiv.className = 'previous-set';
        setDiv.innerText = `Set ${score.set}: {{ partido.equipo.nombre }} ${score.local} - ${score.visitante} {{ partido.rival }}`;
        previousSetsDiv.appendChild(setDiv);
    });
}

function updateTitular(partido_id, jugador_id, posicion) {
    if (jugador_id === "") {
        socket.emit('update_titulares', { partido_id: partido_id, jugador_id: parseInt(jugador_id), action: 'remove', posicion: parseInt(posicion) });
    } else {
        socket.emit('update_titulares', { partido_id: partido_id, jugador_id: parseInt(jugador_id), action: 'add', posicion: parseInt(posicion) });
    }
}

function exportarEstadisticas() {
    const partido_id = {{ partido.id }};
    fetch('/exportar_pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `tipo=por_partido&partido_id=${partido_id}&jugador_id=${selectedPlayer || ''}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            window.open(data.url, '_blank');
        }
    })
    .catch(error => {
        console.error('Error al exportar:', error);
        alert('No se pudo exportar el archivo. Revisa la consola para más detalles.');
    });
}

function grabarJuego() {
    if (confirm('¿Estás seguro de que deseas grabar el juego? Esto reiniciará todas las estadísticas del partido.')) {
        fetch(`/partido/estadisticas/grabar/{{ partido.id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            resetStatsDisplay();
            document.getElementById('scoreLocal').innerText = '0';
            document.getElementById('scoreVisitante').innerText = '0';
            document.getElementById('setNumber').innerText = '1';
            document.getElementById('setScore').innerText = '{{ partido.equipo.nombre }} 0 - 0 {{ partido.rival }}';
            currentSet = 1;
            setsWonLocal = 0;
            setsWonVisitante = 0;
            maxSets = 5;
            setScores = [];
            matchEnded = false;
            displayPreviousSets();
            document.getElementById('localIncrement').disabled = false;
            document.getElementById('localDecrement').disabled = false;
            document.getElementById('visitorIncrement').disabled = false;
            document.getElementById('visitorDecrement').disabled = false;
            for (let pos = 1; pos <= 7; pos++) {
                document.getElementById(`posicion_${pos}`).value = '';
                document.getElementById(`select_btn_${pos}`).classList.remove('btn-warning');
                document.getElementById(`card_${pos}`).classList.remove('selected');
            }
            selectedPlayer = null;
            selectedPosition = null;
            document.getElementById('selectedPlayerName').innerText = '';
            document.getElementById('selectedPlayerNumber').innerText = '';
            document.getElementById('resumenJugador').innerText = 'Selecciona un jugador para ver su resumen.';
        })
        .catch(error => {
            console.error('Error al grabar el juego:', error);
            alert('Error al grabar el juego');
        });
    }
}

function updateResumen(jugador_id) {
    if (!jugador_id) return;
    const playerName = document.getElementById('selectedPlayerName').innerText;
    const resumen = `
${playerName}:
- Saque: Ace ${document.getElementById('saques_ace').innerText}, Errores ${document.getElementById('saques_fallidos').innerText}, Total ${document.getElementById('saques_totales').innerText}
- Ataque: Puntos ${document.getElementById('ataques_puntos').innerText}, Errores ${document.getElementById('ataques_fallidos').innerText}, Bloqueados ${document.getElementById('ataques_bloqueados').innerText}, Efectividad ${document.getElementById('efectividad_ataque').innerText}
- Recepción: Perfectas ${document.getElementById('recepciones_perfectas').innerText}, Positivas ${document.getElementById('recepciones_positivas').innerText}, Errores ${document.getElementById('recepciones_fallidas').innerText}
- Bloqueo: Puntos ${document.getElementById('bloqueos_puntos').innerText}, Toques ${document.getElementById('bloqueos_toques').innerText}
- Defensa: Levantadas ${document.getElementById('defensas_levantadas').innerText}, Errores ${document.getElementById('defensas_fallidas').innerText}
- Asistencia: Asistencias ${document.getElementById('asistencias').innerText}, Errores ${document.getElementById('asistencias_fallidas').innerText}
    `;
    document.getElementById('resumenJugador').innerText = resumen;
}

window.onload = initializeMatchData;

socket.on('connect', () => {
    console.log('Conectado al servidor WebSocket');
});

socket.on('connect_error', (error) => {
    console.error('Error de conexión WebSocket:', error);
});

socket.on('stat_updated', function(data) {
    if (data.jugador_id === selectedPlayer) {
        document.getElementById(`${data.stat}`).innerText = data.value;
        if (data.stat.startsWith('saques_')) {
            document.getElementById('saques_totales').innerText = data.saques_totales || 0;
        } else if (data.stat.startsWith('ataques_')) {
            document.getElementById('efectividad_ataque').innerText = (data.efectividad_ataque || 0).toFixed(2) + '%';
        }
        document.getElementById('recepciones_perfectas').innerText = data.recepciones_perfectas || 0;
        document.getElementById('recepciones_positivas').innerText = data.recepciones_positivas || 0;
        document.getElementById('recepciones_fallidas').innerText = data.recepciones_fallidas || 0;
        document.getElementById('bloqueos_puntos').innerText = data.bloqueos_puntos || 0;
        document.getElementById('bloqueos_toques').innerText = data.bloqueos_toques || 0;
        document.getElementById('defensas_levantadas').innerText = data.defensas_levantadas || 0;
        document.getElementById('defensas_fallidas').innerText = data.defensas_fallidas || 0;
        document.getElementById('asistencias').innerText = data.asistencias || 0;
        document.getElementById('asistencias_fallidas').innerText = data.asistencias_fallidas || 0;
        updateResumen(data.jugador_id);
    }
});

socket.on('score_updated', function(data) {
    document.getElementById('scoreLocal').innerText = data.scoreLocal;
    document.getElementById('scoreVisitante').innerText = data.scoreVisitante;
    setScores = data.set_scores || [];
    setsWonLocal = setScores.filter(s => s.local > s.visitante).length;
    setsWonVisitante = setScores.filter(s => s.visitante > s.local).length;
    currentSet = setScores.length + 1;
    document.getElementById('setScore').innerText = `{{ partido.equipo.nombre }} ${setsWonLocal} - ${setsWonVisitante} {{ partido.rival }}`;
    document.getElementById('setNumber').innerText = currentSet;
    displayPreviousSets();
});

socket.on('titulares_updated', function(data) {
    const titulares = data.titulares;
    if (data.action === 'add') {
        document.getElementById(`posicion_${data.posicion}`).value = data.jugador_id;
    } else if (data.action === 'remove') {
        document.getElementById(`posicion_${data.posicion}`).value = '';
    }
    if (selectedPlayer && !titulares.includes(selectedPlayer)) {
        selectedPlayer = null;
        selectedPosition = null;
        document.querySelectorAll('.player-selector-card').forEach(card => card.classList.remove('selected'));
        document.getElementById('selectedPlayerName').innerText = '';
        document.getElementById('selectedPlayerNumber').innerText = '';
        resetStatsDisplay();
        document.getElementById('resumenJugador').innerText = 'Selecciona un jugador para ver su resumen.';
    } else if (selectedPlayer) {
        selectPlayerFromPosition(selectedPosition);
    }
});

socket.on('positions_rotated', function(data) {
    const posiciones = data.posiciones;
    for (let pos = 1; pos <= 7; pos++) {
        const select = document.getElementById(`posicion_${pos}`);
        const jugador_id = Object.keys(posiciones).find(id => posiciones[id] === pos);
        select.value = jugador_id || '';
    }
    if (selectedPlayer) {
        selectedPosition = Object.keys(posiciones).find(id => parseInt(id) === selectedPlayer) ? posiciones[selectedPlayer] : null;
        if (selectedPosition) {
            selectPlayerFromPosition(selectedPosition);
        } else {
            selectedPlayer = null;
            selectedPosition = null;
            document.querySelectorAll('.player-selector-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('selectedPlayerName').innerText = '';
            document.getElementById('selectedPlayerNumber').innerText = '';
            resetStatsDisplay();
            document.getElementById('resumenJugador').innerText = 'Selecciona un jugador para ver su resumen.';
        }
    }
});

socket.on('titulares_error', function(data) {
    alert(data.message);
});
</script>

{% endblock %}
